name: diut_monitoring

services:
  tempo:
    restart: unless-stopped
    image: grafana/tempo:1.5.0
    command: ['-config.file=/etc/tempo/config.yml']
    volumes:
      - ./configs/tempo/config.yml:/etc/tempo/config.yml
      - tempo-volume:/tmp/tempo
    expose:
      - '14268' # jaeger ingest, Jaeger - Thrift HTTP
      - '14250' # Jaeger - GRPC
      - '55680' # OpenTelemetry
      - '6831/udp' # Jaeger - Thrift Compact
      - '6832/udp' # Jaeger - Thrift Binary
    networks:
      - network

  loki:
    restart: unless-stopped
    image: grafana/loki:2.8.3
    command: -config.file=/etc/loki/config.yml
    expose:
      - 3100
    environment:
      - JAEGER_AGENT_HOST=tempo
      - JAEGER_ENDPOINT=http://tempo:14268/api/traces # send traces to Tempo
      - JAEGER_SAMPLER_TYPE=const
      - JAEGER_SAMPLER_PARAM=1
    volumes:
      - ./configs/loki/config.yml:/etc/loki/config.yml
      # - loki-volume:/tmp/loki
    networks:
      - network

  prometheus:
    restart: unless-stopped
    image: prom/prometheus:v2.37.7
    entrypoint:
      - /bin/prometheus
      - --config.file=/etc/prometheus/config.yml
    volumes:
      - ./configs/prometheus/config.yml:/etc/prometheus/config.yml
    expose:
      - 9090
    ports:
      - '9090:9090'
    networks:
      - network

  grafana:
    restart: unless-stopped
    image: grafana/grafana:9.1.1-ubuntu
    volumes:
      - ./configs/grafana/datasources:/etc/grafana/provisioning/datasources
      - ./configs/grafana/dashboards-provisioning:/etc/grafana/provisioning/dashboards
      - ./configs/grafana/dashboards:/var/lib/grafana/dashboards
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_AUTH_DISABLE_LOGIN_FORM=true
    ports:
      - '3000:3000'
    depends_on:
      - prometheus
      - tempo
      - loki
    networks:
      - network

volumes:
  tempo-volume:

networks:
  network:
